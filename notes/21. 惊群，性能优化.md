# 21. 惊群，性能优化

### 1.1 cpu占比与惊群
> [top -p pid](https://www.cnblogs.com/dragonsuc/p/5512797.html)

**惊群：1个master进程  4个worker进程**

一个连接进入，惊动了4个worker进程，但是只有一个`worker`进程`accept();`其他三个worker进程被惊动，这就叫惊群，但是，这三个被惊动的`worker`进程都做了无用功【操作系统本身的缺陷】

官方nginx解决惊群的办法：进程之间的锁，谁获得这个锁，谁就往监听端口增加`EPOLLIN`标记，有了这个标记，客户端连入就能够被服务器感知到

3.9以上内核版本的linux，在内核中解决了惊群问题，而且性能比官方nginx解决办法效率高很多

==reuseport==（复用端口）,是一种套接字的复用机制，允许将多个套接字bind到同一个ip地址/端口上，这样一来，就可以建立多个服务器来接收到同一个端口的连接【多个worker进程能够监听同一个端口】

**注意：**

* 很多套接字配置项可以通过s`etsockopt()`等等函数来配置
* 还有一些`tcp/ip`协议的一些配置项可以通过修改配置文件来生效

### 1.2 性能优化大局观
* 性能优化无止境无极限
* 没有一个放之四海皆准的优化方法，只能够依据具体情况而定
* 需要不断的探索和尝试

**从两个方面看下性能优化问题：**

* 软件层面：
  * 充分利用cpu，比如惊群问题
  * 深入了解tcp/ip协议，通过一些协议参数配置来进一步改善性能
  * 处理业务逻辑方面，算法方面有些内容，可以提前做好
* 硬件层面：
  * 高速网卡，增加网络带宽
  * 专业服务器，数十个核心
  * 内存：容量大，访问速度快
  * 主板，总线总是不断升级的

### 1.3 性能优化的实施
#### 绑定cpu、提升进程优先级
1. **一个worker进程运行在一个核上，为什么能够提高性能呢？**
   把进程固定到cpu核上，可以大大增加cpu缓存命中率，从而提高程序运行效率
   `worker_cpu_affinity`，把worker进程固定的绑到某个cpu核上
   `ngx_set_cpu_affinity,ngx_setaffinity;`

2. 提升进程优先级，这样这个进程就有机会被分配到更多的cpu时间，得到执行的机会就会增多
   `setpriority()`，干活时进程 处于`R`状态，没有连接连入时，进程处于`S`

   `pidstat - w - p 3660 1`，看某个进程的上下文切换次数[切换频率越低越好]
   `cswch/s`：主动切换/秒：此进程还有运行时间，但是因为阻塞，让出了自己时间片。
   `nvcswch/s`：被动切换/秒：时间片耗尽了，必须要切出去

3. 一个服务器程序，一般只放在一个计算机上跑

#### TCP / IP协议的配置选项
这些配置选项都有缺省值，通过修改，在某些场合下，对性能==可能==会有所提升

* 对要修改的配置项有明确的理解
* 对相关的配置项，记录该配置项的缺省值，做出修改
* 要反复不断的测试验证，是否提升性能，是否有副作用

### 1.4 配置最大允许打开的文件句柄数
`cat /proc/sys/fs/file-max`  ：查看操作系统可以使用的最大句柄数
`cat /proc/sys/fs/file-nr`   ：查看当前已经分配的，分配了没使用的，文件句柄最大数目

限制用户使用的最大句柄数
`/etc/security/limit.conf`
`root soft nofile 60000  :setrlimit(RLIMIT_NOFILE)`
`root hard nofile 60000`

`ulimit -n` ：查看系统允许的当前用户进程打开的文件数限制
`ulimit -HSn 5000`   ：临时设置，只对当前session有效；
n:表示设置的是文件描述符
推荐文章：https://blog.csdn.net/xyang81/article/details/52779229

### 1.5 内存池补充说明
为什么没有用内存池技术：感觉必要性不大
TCMalloc,取代malloc();
库地址：https://github.com/gperftools/gperftools