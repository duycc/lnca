# 19. 控制连入数，畸形包预防

### 1.1 控制并发连入数量
**单纯探讨epoll支持多少并发连接，意义不是很大，并发数量取决于很多因素：**

* 采用的开发技术：epoll，支持数十万并发
* 程序收发数据的频繁程度，以及具体要处理的业务复杂程度
* 实际的物理内存，可用的物理内存数量，直接决定能支持的并发连接
* 一些其他的`tcp/ip`配置项

一般，日常所写的服务器程序，支持几千甚至1-2万的并发，基本上就差不多了。一个服务器程序，要根据具体的物理内存，以及具体要实现的业务等等因素，控制能够同时连入的客户端数量，如果允许客户端无限连入，那么服务器肯定会崩溃

```cpp
m_onlineUserCount // 最大用户连入数
void CSocekt::ngx_event_accept(lpngx_connection_t oldc)   	// 连入人数+1
void CSocekt::inRecyConnectQueue(lpngx_connection_t pConn) 	// 连入人数-1
```


控制连入用户数量的解决思路：==如果同时连入的用户数量超过了允许的最大连入数量时，就把这个连入的用户直接踢出去==

### 1.2 黑客攻击的防范
轻则：服务器工作延迟，效率明显降低；重则整个服务器完全停摆，没有办法提供正常服务，比如拒绝服务攻击就会导致这种状况（服务器失去响应）；最甚者，如果服务器程序写的有一些漏洞的话，恶意黑客很可能利用一些远程溢出攻击手段直接攻破服务器程序所在的计算机，能拿到一定的权限，甚至可能是root权限，一旦拿到了root权限，那么整个计算机都在黑客控制中了

有些攻击是利用`tcp/ip`协议先天的一些设计问题来攻击，比如`syn flood`攻击。DDOS攻击（`syn flood`攻击也是DDOS攻击的一种）防火墙等设备都可能防不住，甚至得从数据路由器想办法，我们写的服务程序，对于DDOS攻击，是没有办法解决的，但是我们写的程序，是能够解决一些用户三路握手连入进来后的一些网络安全问题

#### flood攻击防范
假设认为一个合理的客户端一秒钟发送数据包给服务器不超过10个，如果客户端不停的给服务器发数据包，1秒钟超过了10个数据包 ，服务器就认为这个玩家有恶意攻击服务器的倾向，服务器就应该将这个TCP客户端连接关闭，这个也是服务器发现恶意玩家以及保护自身安全的手段

```cpp
// 代码完善
TestFlood(){}
    
ngx_read_request_handler()
ngx_wait_request_handler_proc_p1()
ngx_wait_request_handler_proc_plast()
```

#### 畸形数据包防范
客户端发送过来的数据并不完全可信，因为这些数据有可能是造假的，甚至可能是畸形的

造假：服务器端书写的时候要细致判断，基本能够避免客户端造假
畸形数据包：远程溢出攻击，攻击成功的主要原因就是服务器程序书写不当，比如接收到的数据缺少边界检查

以`_HandleRegister()`函数为例，有必要在字符数组末尾增加一个 `\0`，以确保使用这个字符数组的时候不会出问题

```cpp
p_RecvInfo->username[sizeof(p_RecvInfo->username) - 1] = 0;
p_RecvInfo->password[sizeof(p_RecvInfo->password) - 1] = 0; 
```

### 1.3 超时直接踢出服务器的需求
==账号服务器==有一个需求：超过20秒不主动断开与本服务器连接的，那么本服务器就要主动的把这个用户踢下线

配置`Sock_TimeOutKick=1`，调整`GetOverTimeTimer()`函数；`procPingTimeOutChecking();`